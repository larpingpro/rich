// Helper to generate 16-character ID: XXXX-XXXX-XXXX-XXXX
function generatePaymentID() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 16; i++) {
        if (i > 0 && i % 4 === 0) result += '-';
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

async function submitPayment() {
    const btn = document.getElementById('submit-btn');
    const hash = document.getElementById('tx-input').value;
    
    if (!hash || hash.length < 5) return alert("Please enter a valid transaction hash.");

    const payId = generatePaymentID();
    btn.innerText = "PROCESSING...";
    btn.style.pointerEvents = "none";

    try {
        const response = await fetch('/api/notify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                txHash: hash, 
                asset: selectedAsset,
                paymentId: payId 
            })
        });

        if (response.ok) {
            // Auto-copy ID to clipboard
            navigator.clipboard.writeText(payId);

            // Update UI to Success State
            document.getElementById('payment-zone').innerHTML = `
                <div class="text-center animate-entry loaded">
                    <div class="w-12 h-12 bg-green-500/20 border border-green-500/50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-green-500"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Request Logged</h3>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-6">Payment ID (Copied):</p>
                    <div class="bg-white/5 border border-orange-500/30 rounded-xl p-4 mb-6">
                        <code class="text-orange-500 font-bold tracking-widest text-lg">${payId}</code>
                    </div>
                    <p class="text-[9px] text-gray-400 uppercase leading-relaxed">
                        Verification in progress. <br>                    </p>
                </div>
            `;
        }
    } catch (e) {
        alert("Verification server unreachable.");
        btn.innerText = "RETRY";
        btn.style.pointerEvents = "auto";
    }
}
